services:
  rug-panel:
    image: erkintop/rug-panel:1.4.4
    container_name: rug-panel
    hostname: rug-panel
    restart: unless-stopped
    networks:
      rug-net:
        ipv4_address: 10.42.42.2
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    ports:
      - "8000:8000/tcp"
      - "51820:51820/udp"
    environment:
      # Server
      - HOST=0.0.0.0
      - PORT=8000
      - DEBUG=false
      - LOG_LEVEL=INFO

      # Security: MUST replace SECRET_KEY with a strong secret value
      - SECRET_KEY=CHANGE_ME_REPLACE_WITH_STRONG_SECRET
      - ACCESS_TOKEN_EXPIRE_MINUTES=1440

      # WireGuard
      - WG_CONFIG_PATH=/app/data/wg0.conf
      - WG_INTERFACE=wg0
      - DEFAULT_WG_PORT=51820
      - DEFAULT_DNS=77.88.8.8, 8.8.8.8
      - DEFAULT_ALLOWED_IPS=0.0.0.0/0, ::/0
      - DEFAULT_PERSISTENT_KEEPALIVE=25

      # Explicitly specify endpoint if you want a fixed external address
      - WG_SERVER_ENDPOINT=

      # Paths inside container
      - DATA_DIR=/app/data
      - DATABASE_PATH=/app/data/panel.db

      # Cache
      - CONFIG_CACHE_TTL=5
      - STATUS_CACHE_TTL=2
      - QR_CACHE_SIZE=100

      # Version/Language
      - PANEL_VERSION=1.4.3
      - LANGUAGE=en

    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv6.conf.all.disable_ipv6=0
      - net.ipv6.conf.all.forwarding=1
      - net.ipv6.conf.default.forwarding=1

    volumes:
      - ./data:/app/data
      - /lib/modules:/lib/modules:ro

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "{{.Name}}"

    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8000/login"]
      interval: 1m
      timeout: 5s
      retries: 3
      start_period: 30s

networks:
  rug-net:
    driver: bridge
    enable_ipv6: true
    ipam:
      driver: default
      config:
        - subnet: 10.42.42.0/24
          gateway: 10.42.42.1
        - subnet: fdcc:ad94:bacf:61a3::/64

# Notes:
# - Before running, replace `SECRET_KEY` with a secure value, e.g.
#   `python -c "import secrets; print(secrets.token_urlsafe(32))"`.
#   Or: openssl rand -base64 32
# - Data files are saved in local `./data` folder.